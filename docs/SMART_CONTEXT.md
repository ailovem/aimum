# AImum 智能上下文管理系统

## 问题

AI 在每次新会话时会丢失上下文，导致：
- 忘记项目状态
- 不知道进行到哪一步
- 重复询问基本信息
- 开发中断不连贯

## 解决方案：预防式自动保存 + 渐进式恢复

### 核心原则

1. **不是清除全部上下文** → 保留核心状态
2. **不是事后恢复** → 断篇前自动保存
3. **不是全部恢复** → 渐进式恢复（核心 → 最近会话）

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                    智能上下文管理系统                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐              │
│  │  核心状态   │   │  会话状态   │   │  断篇前保存 │              │
│  │  (.json)    │   │  (.sessions)│   │  (Hook)    │              │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘              │
│         │                 │                 │                      │
│         │ 永久保留        │ 临时存储        │ 自动触发              │
│         │                 │                 │                      │
│         ▼                 ▼                 ▼                      │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │                   渐进式恢复引擎                        │     │
│  ├─────────────────────────────────────────────────────────┤     │
│  │  1. 恢复核心状态（永久保留）                           │     │
│  │  2. 恢复最近会话（摘要）                               │     │
│  │  3. 显示下一步行动                                     │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 核心组件

### 1. 核心状态文件 (.core-state.json)

**位置**: `D:\openwork\00_active\aimum\.core-state.json`

**内容**:
```json
{
  "projectName": "AImum",
  "phase": "Phase 1 - MVP",
  "progress": 16,
  "completedTasks": ["PRD文档", "技术架构设计", "进度追踪系统"],
  "nextActions": ["推送代码到GitHub", "配置飞书Webhook"],
  "lastUpdated": "2026-02-11T13:16:00.000Z",
  "sessionCount": 5
}
```

**特点**: 永久保留，不会被清除

### 2. 会话状态目录 (.sessions/)

**位置**: `D:\openwork\00_active\aimum\.sessions\`

**内容**:
```
.session/
├── session-1739265600000.json  ← 最近的会话
├── session-1739265300000.json
└── session-1739265000000.json
```

**格式**:
```json
{
  "timestamp": 1739265600000,
  "context": "正在开发用户系统...",
  "summary": "修改了api/user.js..."
}
```

**特点**: 临时存储，可被覆盖

### 3. 自动会话钩子 (session-hook.js)

**功能**:
- 检测会话即将结束
- 自动保存上下文
- 检测长时间无活动
- 自动触发保存

**触发条件**:
- 5分钟无活动 → 自动保存
- 30分钟会话超时 → 自动保存并退出
- 手动调用 `save` 命令

---

## 渐进式恢复流程

```
新会话开始
    │
    ▼
┌───────────────────┐
│ 1. 恢复核心状态   │ ← 永久保留，不会丢失
│   (项目信息、进度)│
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 2. 恢复最近会话   │ ← 可选恢复详细上下文
│   (活动摘要)      │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 3. 显示下一步行动  │ ← 明确下一步做什么
└─────────┬─────────┘
          │
          ▼
    继续开发
```

---

## 使用方式

### 方式 1: 智能启动（推荐）

```bash
cd D:\openwork\00_active\aimum
npm run smart
```

输出示例:
```
🦁 AImum - 智能会话启动器

📦 项目: AImum
📊 阶段: Phase 1 - MVP
🎯 进度: 16%

✅ 已完成任务:
   ✓ PRD文档
   ✓ 技术架构设计
   ✓ 进度追踪系统

📝 下一步行动:
   1. 推送代码到GitHub
   2. 配置飞书Webhook
   3. 开发用户系统
```

### 方式 2: 手动触发

```bash
# 查看状态
npm run status

# 查看进度
npm run tracker

# 手动保存
npm run save

# 恢复上下文
npm run context:restore
```

### 方式 3: OpenClaw 集成

在 OpenClaw 中说：
- "开始开发 AImum"
- "恢复 AImum 上下文"
- "保存当前状态"

---

## 预防性自动保存机制

### 自动检测

| 条件 | 触发动作 |
|------|----------|
| 5分钟无操作 | 自动保存 |
| 30分钟会话超时 | 保存+退出 |
| 切换上下文 | 提示保存 |

### 手动保存

```bash
npm run save
# 或
node scripts/session-hook.js manual_save "保存备注"
```

---

## 关键文件索引

| 文件 | 路径 | 功能 |
|------|------|------|
| 智能启动器 | `D:\openwork\00_active\aimum\scripts\smart-start.js` | 渐进式恢复 |
| 上下文管理器 | `D:\openwork\00_active\aimum\scripts\context-manager.js` | 核心状态管理 |
| 会话钩子 | `D:\openwork\00_active\aimum\scripts\session-hook.js` | 自动保存触发 |
| 核心状态 | `D:\openwork\00_active\aimum\.core-state.json` | 永久保留状态 |
| 会话目录 | `D:\openwork\00_active\aimum\.sessions\` | 临时会话状态 |

---

## 断篇恢复检查清单

如果忘记了项目状态，按以下顺序检查：

1. **运行智能启动** (最快)
   ```bash
   npm run smart
   ```

2. **查看核心状态** (最准确)
   ```bash
   npm run context:status
   ```

3. **查看记忆文件** (最完整)
   - 打开 `D:\openwork\AIopenclaw\AImum-MEMORY.md`
   - 打开 `D:\openwork\00_active\aimum\PRD.md`

4. **查看 GitHub** (最新)
   - https://github.com/ailovem/aimum/commits/main

---

## 命令速查表

| 命令 | 功能 |
|------|------|
| `npm run smart` | 智能启动，渐进式恢复 |
| `npm run status` | 查看项目状态 |
| `npm run tracker` | 查看开发进度 |
| `npm run save` | 手动保存上下文 |
| `npm run context:restore` | 恢复上下文 |
| `npm run dev` | 本地开发 |
| `npm run deploy` | 部署项目 |

---

## 为什么不会断篇？

### ✅ 预防机制

1. **自动保存** - 断篇前自动保存
2. **核心保留** - 核心状态永久保存
3. **渐进恢复** - 不是全部恢复，是渐进式

### ✅ 多层备份

1. **本地核心状态** - `.core-state.json`
2. **本地会话状态** - `.sessions/`
3. **OpenClaw 记忆** - `MEMORY.md`
4. **GitHub 仓库** - 代码+文档

### ✅ 快速恢复

1. `npm run smart` - 10秒内恢复
2. 查看核心状态 - 5秒
3. 查看记忆文件 - 随时

---

**💡 记住**: 任何时候忘记了，运行 `npm run smart`！🦁
