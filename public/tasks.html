<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»»åŠ¡åˆ†è§£ - AImum</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #6366f1;
      --accent: #22d3ee;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #0a0a0f;
      --bg-card: #111118;
      --bg-card-hover: #1a1a24;
      --text: #f4f4f5;
      --text-dim: #71717a;
      --border: rgba(255,255,255,0.08);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
    }
    
    h1 { font-size: 20px; font-weight: 600; }
    
    /* ä»»åŠ¡è¾“å…¥åŒº */
    .task-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .input-group {
      display: flex;
      gap: 12px;
    }
    
    .task-input {
      flex: 1;
      padding: 14px 18px;
      background: var(--bg-card-hover);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
    }
    
    .task-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .execute-btn {
      padding: 14px 28px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .execute-btn:hover {
      transform: translateY(-2px);
    }
    
    .execute-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* å¿«æ·ä»»åŠ¡ */
    .quick-tasks {
      margin-top: 16px;
    }
    
    .quick-title {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 10px;
    }
    
    .quick-btns {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .quick-btn {
      padding: 8px 16px;
      background: var(--bg-card-hover);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-dim);
      font-size: 13px;
      cursor: pointer;
    }
    
    .quick-btn:hover {
      border-color: var(--primary);
      color: var(--text);
    }
    
    /* ä»»åŠ¡è®¡åˆ’ */
    .plan-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      display: none;
    }
    
    .plan-section.show {
      display: block;
    }
    
    .plan-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .plan-steps {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .plan-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-card-hover);
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    
    .step-number {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }
    
    .step-content {
      flex: 1;
    }
    
    .step-name {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .step-command {
      font-family: monospace;
      font-size: 12px;
      color: var(--text-dim);
      background: var(--bg);
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .plan-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .plan-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .plan-btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
    }
    
    .plan-btn.secondary {
      background: var(--bg-card-hover);
      color: var(--text);
    }
    
    /* æ‰§è¡Œè¿›åº¦ */
    .progress-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      display: none;
    }
    
    .progress-section.show {
      display: block;
    }
    
    .progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .progress-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .progress-percent {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .progress-bar {
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 4px;
      transition: width 0.3s;
    }
    
    .exec-steps {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .exec-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-card-hover);
      border-radius: 10px;
    }
    
    .exec-step.running {
      border: 1px solid var(--primary);
    }
    
    .exec-step.success {
      border-left: 3px solid var(--success);
    }
    
    .exec-step.error {
      border-left: 3px solid var(--danger);
    }
    
    .exec-step.pending {
      opacity: 0.5;
    }
    
    .exec-icon {
      font-size: 16px;
    }
    
    .exec-content {
      flex: 1;
    }
    
    .exec-name {
      font-size: 13px;
      font-weight: 500;
    }
    
    .exec-cmd {
      font-family: monospace;
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 4px;
    }
    
    .exec-result {
      font-size: 11px;
      color: var(--success);
    }
    
    .exec-result.error {
      color: var(--danger);
    }
    
    /* ä»»åŠ¡æ¨¡æ¿ */
    .templates-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
    }
    
    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .template-card {
      background: var(--bg-card-hover);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .template-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    
    .template-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }
    
    .template-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    
    .template-desc {
      font-size: 12px;
      color: var(--text-dim);
    }
    
    /* èŠå¤©å¼è¾“å‡º */
    .chat-output {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-top: 24px;
    }
    
    .chat-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .chat-messages {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .chat-msg {
      display: flex;
      gap: 10px;
    }
    
    .chat-msg.user {
      flex-direction: row-reverse;
    }
    
    .chat-avatar {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .chat-msg.user .chat-avatar {
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
    }
    
    .chat-msg.assistant .chat-avatar {
      background: linear-gradient(135deg, #22d3ee, var(--primary));
    }
    
    .chat-content {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.6;
    }
    
    .chat-msg.user .chat-content {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .chat-msg.assistant .chat-content {
      background: var(--bg-card-hover);
      border-bottom-left-radius: 4px;
    }
    
    .chat-content pre {
      background: var(--bg);
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button class="back-btn" onclick="location.href='core.html'">
        â† è¿”å›
      </button>
      <h1>ğŸ§  ä»»åŠ¡åˆ†è§£å™¨</h1>
      <div></div>
    </header>
    
    <!-- ä»»åŠ¡è¾“å…¥ -->
    <div class="task-section">
      <div class="section-title">ğŸ“ è¾“å…¥ä»»åŠ¡ç›®æ ‡</div>
      <div class="input-group">
        <input type="text" class="task-input" id="taskInput" 
               placeholder="ä¾‹å¦‚ï¼šå¸®æˆ‘æ•´ç†æ¡Œé¢ã€åˆ›å»ºé¡¹ç›®ã€æ¸…ç†ä¸‹è½½æ–‡ä»¶å¤¹" 
               onkeydown="if(event.key==='Enter')parseTask()">
        <button class="execute-btn" id="parseBtn" onclick="parseTask()">
          åˆ†æä»»åŠ¡
        </button>
      </div>
      
      <div class="quick-tasks">
        <div class="quick-title">ğŸ’¡ å¿«æ·ä»»åŠ¡ï¼š</div>
        <div class="quick-btns">
          <button class="quick-btn" onclick="quickTask('æ•´ç†æ¡Œé¢')">ğŸ§¹ æ•´ç†æ¡Œé¢</button>
          <button class="quick-btn" onclick="quickTask('æ•´ç†ä¸‹è½½')">ğŸ“¦ æ•´ç†ä¸‹è½½</button>
          <button class="quick-btn" onclick="quickTask('åˆ›å»ºé¡¹ç›®')">ğŸ“ åˆ›å»ºé¡¹ç›®</button>
          <button class="quick-btn" onclick="quickTask('æ¸…ç†ä¸´æ—¶æ–‡ä»¶')">ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶</button>
          <button class="quick-btn" onclick="quickTask('å¤‡ä»½æ¡Œé¢')">ğŸ’¾ å¤‡ä»½æ¡Œé¢</button>
        </div>
      </div>
    </div>
    
    <!-- ä»»åŠ¡è®¡åˆ’ -->
    <div class="plan-section" id="planSection">
      <div class="plan-title">
        <span>ğŸ“‹</span> ä»»åŠ¡æ‰§è¡Œè®¡åˆ’
      </div>
      <div class="plan-steps" id="planSteps"></div>
      <div class="plan-actions">
        <button class="plan-btn secondary" onclick="cancelPlan()">å–æ¶ˆ</button>
        <button class="plan-btn primary" id="confirmBtn" onclick="executePlan()">
          å¼€å§‹æ‰§è¡Œ
        </button>
      </div>
    </div>
    
    <!-- æ‰§è¡Œè¿›åº¦ -->
    <div class="progress-section" id="progressSection">
      <div class="progress-header">
        <div class="progress-info">
          <div class="progress-percent" id="progressPercent">0%</div>
          <div style="font-size: 13px; color: var(--text-dim);">
            <span id="currentStep">0</span> / <span id="totalSteps">0</span> æ­¥éª¤
          </div>
        </div>
        <div style="font-size: 13px; color: var(--text-dim);" id="progressStatus">
          å‡†å¤‡ä¸­...
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="exec-steps" id="execSteps"></div>
    </div>
    
    <!-- èŠå¤©è¾“å‡º -->
    <div class="chat-output" id="chatOutput" style="display: none;">
      <div class="chat-title">ğŸ’¬ æ‰§è¡Œè¿‡ç¨‹</div>
      <div class="chat-messages" id="chatMessages"></div>
    </div>
    
    <!-- ä»»åŠ¡æ¨¡æ¿ -->
    <div class="templates-section">
      <div class="section-title">ğŸ“š å¸¸ç”¨ä»»åŠ¡æ¨¡æ¿</div>
      <div class="templates-grid">
        <div class="template-card" onclick="quickTask('æ•´ç†æ¡Œé¢')">
          <div class="template-icon">ğŸ§¹</div>
          <div class="template-name">æ•´ç†æ¡Œé¢</div>
          <div class="template-desc">è‡ªåŠ¨åˆ†ç±»æ•´ç†æ¡Œé¢æ–‡ä»¶</div>
        </div>
        <div class="template-card" onclick="quickTask('æ•´ç†ä¸‹è½½')">
          <div class="template-icon">ğŸ“¦</div>
          <div class="template-name">æ•´ç†ä¸‹è½½</div>
          <div class="template-desc">æ¸…ç†ä¸‹è½½æ–‡ä»¶å¤¹</div>
        </div>
        <div class="template-card" onclick="quickTask('åˆ›å»ºé¡¹ç›®')">
          <div class="template-icon">ğŸ“</div>
          <div class="template-name">åˆ›å»ºé¡¹ç›®</div>
          <div class="template-desc">åˆå§‹åŒ–é¡¹ç›®ç»“æ„</div>
        </div>
        <div class="template-card" onclick="quickTask('æ¸…ç†ä¸´æ—¶æ–‡ä»¶')">
          <div class="template-icon">ğŸ—‘ï¸</div>
          <div class="template-name">æ¸…ç†ä¸´æ—¶æ–‡ä»¶</div>
          <div class="template-desc">æ¸…ç†ç³»ç»Ÿå’Œä¸´æ—¶æ–‡ä»¶</div>
        </div>
        <div class="template-card" onclick="quickTask('å¤‡ä»½é‡è¦æ–‡ä»¶')">
          <div class="template-icon">ğŸ’¾</div>
          <div class="template-name">å¤‡ä»½é‡è¦æ–‡ä»¶</div>
          <div class="template-desc">å¤‡ä»½æ¡Œé¢å’Œæ–‡æ¡£</div>
        </div>
        <div class="template-card" onclick="quickTask('å®‰è£…å¼€å‘ç¯å¢ƒ')">
          <div class="template-icon">âš™ï¸</div>
          <div class="template-name">å®‰è£…å¼€å‘ç¯å¢ƒ</div>
          <div class="template-desc">å¿«é€Ÿæ­å»ºå¼€å‘ç¯å¢ƒ</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // ä»»åŠ¡æ¨¡æ¿åº“
    const TASK_TEMPLATES = {
      'æ•´ç†æ¡Œé¢': {
        icon: 'ğŸ§¹',
        name: 'æ•´ç†æ¡Œé¢',
        description: 'è‡ªåŠ¨åˆ†ç±»æ•´ç†æ¡Œé¢æ–‡ä»¶',
        steps: [
          { name: 'æŸ¥çœ‹æ¡Œé¢æ–‡ä»¶', cmd: 'dir "%USERPROFILE%\\Desktop"' },
          { name: 'åˆ›å»ºåˆ†ç±»æ–‡ä»¶å¤¹', cmd: 'mkdir "%USERPROFILE%\\Desktop\\æ–‡æ¡£"' },
          { name: 'åˆ›å»ºå›¾ç‰‡æ–‡ä»¶å¤¹', cmd: 'mkdir "%USERPROFILE%\\Desktop\\å›¾ç‰‡"' },
          { name: 'åˆ›å»ºå®‰è£…åŒ…æ–‡ä»¶å¤¹', cmd: 'mkdir "%USERPROFILE%\\Desktop\\å®‰è£…åŒ…"' },
          { name: 'åˆ›å»ºå…¶ä»–æ–‡ä»¶å¤¹', cmd: 'mkdir "%USERPROFILE%\\Desktop\\å…¶ä»–"' }
        ]
      },
      'æ•´ç†ä¸‹è½½': {
        icon: 'ğŸ“¦',
        name: 'æ•´ç†ä¸‹è½½',
        description: 'æ¸…ç†ä¸‹è½½æ–‡ä»¶å¤¹',
        steps: [
          { name: 'æŸ¥çœ‹ä¸‹è½½æ–‡ä»¶å¤¹', cmd: 'dir "%USERPROFILE%\\Downloads"' },
          { name: 'åˆ›å»ºåˆ†ç±»æ–‡ä»¶å¤¹', cmd: 'mkdir "%USERPROFILE%\\Downloads\\å®‰è£…åŒ…" && mkdir "%USERPROFILE%\\Downloads\\æ–‡æ¡£" && mkdir "%USERPROFILE%\\Downloads\\å›¾ç‰‡"' }
        ]
      },
      'åˆ›å»ºé¡¹ç›®': {
        icon: 'ğŸ“',
        name: 'åˆ›å»ºé¡¹ç›®',
        description: 'åˆå§‹åŒ–é¡¹ç›®ç»“æ„',
        steps: [
          { name: 'åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹', cmd: 'mkdir "C:\\Users\\dongd\\Desktop\\MyProject"' },
          { name: 'åˆ›å»º src ç›®å½•', cmd: 'mkdir "C:\\Users\\dongd\\Desktop\\MyProject\\src"' },
          { name: 'åˆ›å»º docs ç›®å½•', cmd: 'mkdir "C:\\Users\\dongd\\Desktop\\MyProject\\docs"' },
          { name: 'åˆ›å»º README', cmd: 'echo. > "C:\\Users\\dongd\\Desktop\\MyProject\\README.md"' }
        ]
      },
      'æ¸…ç†ä¸´æ—¶æ–‡ä»¶': {
        icon: 'ğŸ—‘ï¸',
        name: 'æ¸…ç†ä¸´æ—¶æ–‡ä»¶',
        description: 'æ¸…ç†ç³»ç»Ÿå’Œä¸´æ—¶æ–‡ä»¶',
        steps: [
          { name: 'æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤¹', cmd: 'del /q "%TEMP%\\*.*" 2>nul' },
          { name: 'æ¸…ç†æµè§ˆå™¨ç¼“å­˜', cmd: 'echo å»ºè®®æ‰‹åŠ¨æ¸…ç†æµè§ˆå™¨ç¼“å­˜' },
          { name: 'æ¸…ç†å›æ”¶ç«™', cmd: 'echo è¯·æ‰‹åŠ¨æ¸…ç©ºå›æ”¶ç«™' }
        ]
      },
      'å¤‡ä»½æ¡Œé¢': {
        icon: 'ğŸ’¾',
        name: 'å¤‡ä»½æ¡Œé¢',
        description: 'å¤‡ä»½æ¡Œé¢é‡è¦æ–‡ä»¶',
        steps: [
          { name: 'åˆ›å»ºå¤‡ä»½æ–‡ä»¶å¤¹', cmd: 'mkdir "%USERPROFILE%\\Desktop\\Backup"' },
          { name: 'å¤‡ä»½æ–‡ä»¶', cmd: 'xcopy "%USERPROFILE%\\Desktop\\*.docx" "%USERPROFILE%\\Desktop\\Backup\\" /y' },
          { name: 'å¤‡ä»½å®Œæˆ', cmd: 'echo å¤‡ä»½å®Œæˆ' }
        ]
      }
    };
    
    let currentPlan = null;
    let currentStep = 0;
    let chatMessages = [];
    
    function quickTask(taskName) {
      document.getElementById('taskInput').value = taskName;
      parseTask();
    }
    
    function addChat(role, content) {
      chatMessages.push({ role, content });
      renderChat();
    }
    
    function renderChat() {
      const chatOutput = document.getElementById('chatOutput');
      const chatMessagesEl = document.getElementById('chatMessages');
      
      if (chatMessages.length > 0) {
        chatOutput.style.display = 'block';
        chatMessagesEl.innerHTML = chatMessages.map(msg => `
          <div class="chat-msg ${msg.role}">
            <div class="chat-avatar">${msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¦'}</div>
            <div class="chat-content">${formatContent(msg.content)}</div>
          </div>
        `).join('');
      }
    }
    
    function formatContent(content) {
      if (content.includes('\n')) {
        return `<pre>${escapeHtml(content)}</pre>`;
      }
      return escapeHtml(content).replace(/\n/g, '<br>');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function parseTask() {
      const input = document.getElementById('taskInput').value.trim();
      if (!input) return;
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      chatMessages = [];
      addChat('user', input);
      
      // åˆ†æä»»åŠ¡
      const taskName = findBestMatch(input);
      
      if (taskName && TASK_TEMPLATES[taskName]) {
        currentPlan = TASK_TEMPLATES[taskName];
        showPlan();
        addChat('assistant', `ğŸ¯ ç†è§£ä»»åŠ¡ï¼š**${currentPlan.name}**\n\n${currentPlan.description}\n\nå…± ${currentPlan.steps.length} ä¸ªæ­¥éª¤ï¼Œç¡®è®¤åå¼€å§‹æ‰§è¡Œã€‚`);
      } else {
        addChat('assistant', `ğŸ¤” æš‚ä¸æ”¯æŒè¯¥ä»»åŠ¡ "${input}"\n\nå¯é€‰ä»»åŠ¡ï¼š\nâ€¢ æ•´ç†æ¡Œé¢\nâ€¢ æ•´ç†ä¸‹è½½\nâ€¢ åˆ›å»ºé¡¹ç›®\nâ€¢ æ¸…ç†ä¸´æ—¶æ–‡ä»¶\nâ€¢ å¤‡ä»½æ¡Œé¢`);
      }
    }
    
    function findBestMatch(input) {
      const lower = input.toLowerCase();
      
      // å…³é”®è¯åŒ¹é…
      if (lower.includes('æ¡Œé¢') && (lower.includes('æ•´ç†') || lower.includes('æ¸…ç†'))) return 'æ•´ç†æ¡Œé¢';
      if (lower.includes('ä¸‹è½½') && (lower.includes('æ•´ç†') || lower.includes('æ¸…ç†'))) return 'æ•´ç†ä¸‹è½½';
      if (lower.includes('é¡¹ç›®') && (lower.includes('åˆ›å»º') || lower.includes('æ–°å»º'))) return 'åˆ›å»ºé¡¹ç›®';
      if (lower.includes('ä¸´æ—¶') && (lower.includes('æ¸…ç†') || lower.includes('åˆ é™¤'))) return 'æ¸…ç†ä¸´æ—¶æ–‡ä»¶';
      if (lower.includes('å¤‡ä»½') || lower.includes('å¤‡ä»½')) return 'å¤‡ä»½æ¡Œé¢';
      
      // æ¨¡ç³ŠåŒ¹é…
      for (const [name, template] of Object.entries(TASK_TEMPLATES)) {
        if (lower.includes(name.toLowerCase())) return name;
      }
      
      return null;
    }
    
    function showPlan() {
      const section = document.getElementById('planSection');
      const stepsEl = document.getElementById('planSteps');
      
      section.classList.add('show');
      
      stepsEl.innerHTML = currentPlan.steps.map((step, i) => `
        <div class="plan-step">
          <div class="step-number">${i + 1}</div>
          <div class="step-content">
            <div class="step-name">${step.name}</div>
            <div class="step-command">${step.cmd}</div>
          </div>
        </div>
      `).join('');
    }
    
    function cancelPlan() {
      document.getElementById('planSection').classList.remove('show');
      document.getElementById('progressSection').classList.remove('show');
      currentPlan = null;
    }
    
    async function executePlan() {
      if (!currentPlan) return;
      
      // éšè—è®¡åˆ’ï¼Œæ˜¾ç¤ºè¿›åº¦
      document.getElementById('planSection').classList.remove('show');
      document.getElementById('progressSection').classList.add('show');
      
      const total = currentPlan.steps.length;
      document.getElementById('totalSteps').textContent = total;
      currentStep = 0;
      
      addChat('assistant', `ğŸš€ å¼€å§‹æ‰§è¡Œï¼š**${currentPlan.name}**\n\nè¯·ç¨å€™...`);
      
      // åˆå§‹åŒ–è¿›åº¦æ¡
      updateProgress(0, 'å‡†å¤‡æ‰§è¡Œ...');
      renderExecSteps();
      
      // ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªæ­¥éª¤
      for (let i = 0; i < currentPlan.steps.length; i++) {
        const step = currentPlan.steps[i];
        currentStep = i + 1;
        
        updateProgress((i / total) * 100, `æ‰§è¡Œä¸­: ${step.name}`);
        updateExecStep(i, 'running');
        
        // æ‰§è¡Œå‘½ä»¤
        const result = await executeCommand(step.cmd);
        
        if (result.success) {
          updateExecStep(i, 'success', 'âœ… æˆåŠŸ');
          if (result.output) {
            addChat('assistant', `âœ… ${step.name}\n${result.output}`);
          }
        } else {
          updateExecStep(i, 'error', 'âŒ å¤±è´¥: ' + result.error);
          addChat('assistant', `âŒ ${step.name} å¤±è´¥\n${result.error}`);
        }
        
        // å»¶è¿Ÿä¸€ä¸‹ï¼Œæ¨¡æ‹Ÿæ‰§è¡Œè¿‡ç¨‹
        await new Promise(r => setTimeout(r, 500));
      }
      
      // å®Œæˆ
      updateProgress(100, 'æ‰§è¡Œå®Œæˆï¼');
      addChat('assistant', `ğŸ‰ **${currentPlan.name} å®Œæˆï¼**\n\næ‰€æœ‰æ­¥éª¤å·²æ‰§è¡Œå®Œæ¯•ã€‚`);
    }
    
    async function executeCommand(cmd) {
      try {
        const res = await fetch('/api/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: cmd })
        });
        return await res.json();
      } catch (e) {
        return { success: false, error: e.message };
      }
    }
    
    function updateProgress(percent, status) {
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
      document.getElementById('currentStep').textContent = currentStep;
      document.getElementById('progressStatus').textContent = status;
    }
    
    function renderExecSteps() {
      const stepsEl = document.getElementById('execSteps');
      stepsEl.innerHTML = currentPlan.steps.map((step, i) => `
        <div class="exec-step pending" id="exec-step-${i}">
          <div class="exec-icon" id="exec-icon-${i}">â³</div>
          <div class="exec-content">
            <div class="exec-name">${step.name}</div>
            <div class="exec-cmd">${step.cmd}</div>
          </div>
          <div class="exec-result" id="exec-result-${i}"></div>
        </div>
      `).join('');
    }
    
    function updateExecStep(index, status, resultText = '') {
      const stepEl = document.getElementById(`exec-step-${index}`);
      const iconEl = document.getElementById(`exec-icon-${index}`);
      const resultEl = document.getElementById(`exec-result-${index}`);
      
      stepEl.className = 'exec-step ' + status;
      resultEl.textContent = resultText;
      resultEl.className = 'exec-result' + (status === 'error' ? ' error' : '');
      
      const icons = { pending: 'â³', running: 'ğŸ”„', success: 'âœ…', error: 'âŒ' };
      iconEl.textContent = icons[status];
    }
  </script>
</body>
</html>
