<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AImum - AI å¯¹è¯</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #667eea;
      --bg: #0f0f23;
      --card: #1a1a2e;
      --input-bg: #252542;
      --text: #e2e8f0;
      --text-dim: #a0aec0;
      --user-msg: #3b82f6;
      --ai-msg: #374151;
      --border: rgba(255,255,255,0.1);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
    }
    
    /* ä¾§è¾¹æ  */
    .sidebar {
      width: 280px;
      background: var(--card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .logo {
      font-size: 24px;
      margin-bottom: 16px;
    }
    
    .new-chat-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    
    .new-chat-btn:hover {
      background: #5a67d8;
    }
    
    .conversations {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    .conversation-item {
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 4px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .conversation-item:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .conversation-item.active {
      background: rgba(102, 126, 234, 0.2);
    }
    
    .conversation-icon {
      font-size: 20px;
    }
    
    .conversation-info {
      flex: 1;
      min-width: 0;
    }
    
    .conversation-title {
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .conversation-time {
      font-size: 12px;
      color: var(--text-dim);
    }
    
    /* è®¾ç½®åŒº */
    .settings-section {
      padding: 16px;
      border-top: 1px solid var(--border);
    }
    
    .settings-title {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .setting-row {
      margin-bottom: 16px;
    }
    
    .setting-label {
      font-size: 13px;
      color: var(--text-dim);
      margin-bottom: 8px;
      display: block;
    }
    
    .setting-select {
      width: 100%;
      padding: 10px 12px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }
    
    .setting-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* ä¸»èŠå¤©åŒº */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .chat-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .chat-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .chat-model {
      font-size: 13px;
      color: var(--text-dim);
      background: var(--input-bg);
      padding: 6px 12px;
      border-radius: 20px;
    }
    
    /* æ¶ˆæ¯åŒº */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }
    
    .message {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .message.user {
      flex-direction: row-reverse;
    }
    
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .message.user .message-avatar {
      background: var(--primary);
    }
    
    .message.assistant .message-avatar {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .message-content {
      background: var(--ai-msg);
      padding: 14px 18px;
      border-radius: 16px;
      max-width: 70%;
      line-height: 1.6;
    }
    
    .message.user .message-content {
      background: var(--user-msg);
    }
    
    .message-role {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 6px;
    }
    
    .message-text {
      font-size: 15px;
    }
    
    .message-text p {
      margin-bottom: 8px;
    }
    
    .message-text p:last-child {
      margin-bottom: 0;
    }
    
    .message-text code {
      background: rgba(0,0,0,0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Fira Code', monospace;
      font-size: 13px;
    }
    
    .message-text pre {
      background: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
    }
    
    /* è¾“å…¥åŒº */
    .input-area {
      padding: 20px 24px;
      border-top: 1px solid var(--border);
    }
    
    .input-container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .input-wrapper {
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 16px;
      display: flex;
      align-items: flex-end;
      gap: 12px;
      transition: all 0.2s;
    }
    
    .input-wrapper:focus-within {
      border-color: var(--primary);
    }
    
    .input-textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 15px;
      line-height: 1.5;
      resize: none;
      max-height: 150px;
    }
    
    .input-textarea:focus {
      outline: none;
    }
    
    .input-textarea::placeholder {
      color: var(--text-dim);
    }
    
    .send-btn {
      width: 40px;
      height: 40px;
      background: var(--primary);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .send-btn:hover {
      background: #5a67d8;
    }
    
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .send-btn svg {
      width: 20px;
      height: 20px;
    }
    
    .input-hint {
      text-align: center;
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 12px;
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-dim);
      text-align: center;
      padding: 40px;
    }
    
    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .empty-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    
    .empty-desc {
      font-size: 14px;
      max-width: 400px;
    }
    
    /* æç¤ºè¯æ¨¡æ¿ */
    .prompts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 24px;
      max-width: 600px;
    }
    
    .prompt-item {
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .prompt-item:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.1);
    }
    
    .prompt-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .prompt-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .prompt-desc {
      font-size: 12px;
      color: var(--text-dim);
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 0;
    }
    
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: var(--text-dim);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.2); opacity: 1; }
    }
    
    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      
      .message-content {
        max-width: 90%;
      }
      
      .prompts {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo">ğŸ¦ AImum</div>
      <button class="new-chat-btn" onclick="newChat()">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        æ–°å»ºå¯¹è¯
      </button>
    </div>
    
    <div class="conversations" id="conversations">
      <!-- å¯¹è¯åˆ—è¡¨ -->
    </div>
    
    <div class="settings-section">
      <div class="settings-title">æ¨¡å‹é€‰æ‹©</div>
      
      <div class="setting-row">
        <label class="setting-label">AI æ¨¡å‹</label>
        <select class="setting-select" id="modelSelect" onchange="changeModel()">
          <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
          <option value="claude-haiku-3-20250514">Claude Haiku 3</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4o-mini">GPT-4o Mini</option>
          <option value="deepseek-chat">DeepSeek Chat</option>
        </select>
      </div>
      
      <div class="setting-row">
        <label class="setting-label">è§’è‰²</label>
        <select class="setting-select" id="roleSelect" onchange="changeRole()">
          <option value="default">é»˜è®¤åŠ©æ‰‹</option>
          <option value="coder">ä»£ç ä¸“å®¶</option>
          <option value="writer">å†™ä½œåŠ©æ‰‹</option>
          <option value="analyst">æ•°æ®åˆ†æå¸ˆ</option>
        </select>
      </div>
    </div>
  </div>
  
  <!-- ä¸»èŠå¤©åŒº -->
  <div class="main">
    <div class="chat-header">
      <div class="chat-title" id="chatTitle">AI å¯¹è¯</div>
      <div class="chat-model" id="currentModel">Claude Sonnet 4</div>
    </div>
    
    <div class="messages" id="messages">
      <!-- ç©ºçŠ¶æ€ -->
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">ğŸ’¬</div>
        <div class="empty-title">å¼€å§‹ä¸ AI å¯¹è¯</div>
        <div class="empty-desc">é€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼Œå¼€å§‹ä½ çš„æ™ºèƒ½å¯¹è¯ä¹‹æ—…</div>
        
        <div class="prompts">
          <div class="prompt-item" onclick="usePrompt('coder', 'å¸®æˆ‘å†™ä¸€ä¸ª Python å¿«é€Ÿæ’åºç®—æ³•')">
            <div class="prompt-icon">ğŸ‘¨â€ğŸ’»</div>
            <div class="prompt-title">ä»£ç ä¸“å®¶</div>
            <div class="prompt-desc">å†™ç®—æ³•ã€è°ƒè¯•ä»£ç </div>
          </div>
          
          <div class="prompt-item" onclick="usePrompt('writer', 'å¸®æˆ‘å†™ä¸€ç¯‡äº§å“å‘å¸ƒæ–‡æ¡ˆ')">
            <div class="prompt-icon">âœï¸</div>
            <div class="prompt-title">å†™ä½œåŠ©æ‰‹</div>
            <div class="prompt-desc">æ–‡ç« ã€æ–‡æ¡ˆã€ç¿»è¯‘</div>
          </div>
          
          <div class="prompt-item" onclick="usePrompt('analyst', 'åˆ†æè¿™ä»½é”€å”®æ•°æ®å¹¶ç»™å‡ºå»ºè®®')">
            <div class="prompt-icon">ğŸ“Š</div>
            <div class="prompt-title">æ•°æ®åˆ†æå¸ˆ</div>
            <div class="prompt-desc">æ•°æ®åˆ†æã€å›¾è¡¨è§£è¯»</div>
          </div>
          
          <div class="prompt-item" onclick="usePrompt('default', 'å¸®æˆ‘è§„åˆ’ä¸‹ä»Šå¤©çš„å·¥ä½œ')">
            <div class="prompt-icon">ğŸ“‹</div>
            <div class="prompt-title">é»˜è®¤åŠ©æ‰‹</div>
            <div class="prompt-desc">æ—¥å¸¸é—®ç­”ã€ä»»åŠ¡è§„åˆ’</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="input-area">
      <div class="input-container">
        <div class="input-wrapper">
          <textarea 
            class="input-textarea" 
            id="messageInput"
            placeholder="è¾“å…¥æ¶ˆæ¯..."
            rows="1"
            onkeydown="handleKeydown(event)"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
        <div class="input-hint">
          æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // é…ç½®
    const API_BASE = '/api/chat';
    const API_AUTH = '/api/auth';
    
    // çŠ¶æ€
    let currentConversationId = null;
    let currentModel = 'claude-sonnet-4-20250514';
    let currentRole = 'default';
    let isLoading = false;
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      checkLogin();
      loadConversations();
      autoResizeTextarea();
    });
    
    // æ£€æŸ¥ç™»å½•
    async function checkLogin() {
      const token = localStorage.getItem('aimum_token');
      
      if (!token) {
        // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/auth.html';
        return;
      }
      
      // éªŒè¯ Token
      try {
        const res = await fetch(`${API_AUTH}/verify`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await res.json();
        
        if (!data.success) {
          localStorage.removeItem('aimum_token');
          localStorage.removeItem('aimum_user');
          window.location.href = '/auth.html';
        }
      } catch (e) {
        console.error('éªŒè¯å¤±è´¥:', e);
      }
    }
    
    // åŠ è½½å¯¹è¯åˆ—è¡¨
    async function loadConversations() {
      const conversationsEl = document.getElementById('conversations');
      conversationsEl.innerHTML = `
        <div class="conversation-item active" onclick="selectConversation(null)">
          <span class="conversation-icon">ğŸ’¬</span>
          <div class="conversation-info">
            <div class="conversation-title">æ–°å¯¹è¯</div>
          </div>
        </div>
      `;
    }
    
    // é€‰æ‹©å¯¹è¯
    function selectConversation(conversationId) {
      currentConversationId = conversationId;
      
      // æ›´æ–° UI
      document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
      });
      
      if (conversationId) {
        loadHistory(conversationId);
      } else {
        showEmptyState();
      }
    }
    
    // æ–°å¯¹è¯
    function newChat() {
      currentConversationId = null;
      showEmptyState();
      
      document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector('.conversation-item').classList.add('active');
    }
    
    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
      document.getElementById('messages').innerHTML = `
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">ğŸ’¬</div>
          <div class="empty-title">å¼€å§‹ä¸ AI å¯¹è¯</div>
          <div class="empty-desc">é€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼Œå¼€å§‹ä½ çš„æ™ºèƒ½å¯¹è¯ä¹‹æ—…</div>
          
          <div class="prompts">
            <div class="prompt-item" onclick="usePrompt('coder', 'å¸®æˆ‘å†™ä¸€ä¸ª Python å¿«é€Ÿæ’åºç®—æ³•')">
              <div class="prompt-icon">ğŸ‘¨â€ğŸ’»</div>
              <div class="prompt-title">ä»£ç ä¸“å®¶</div>
              <div class="prompt-desc">å†™ç®—æ³•ã€è°ƒè¯•ä»£ç </div>
            </div>
            
            <div class="prompt-item" onclick="usePrompt('writer', 'å¸®æˆ‘å†™ä¸€ç¯‡äº§å“å‘å¸ƒæ–‡æ¡ˆ')">
              <div class="prompt-icon">âœï¸</div>
              <div class="prompt-title">å†™ä½œåŠ©æ‰‹</div>
              <div class="prompt-desc">æ–‡ç« ã€æ–‡æ¡ˆã€ç¿»è¯‘</div>
            </div>
            
            <div class="prompt-item" onclick="usePrompt('analyst', 'åˆ†æè¿™ä»½é”€å”®æ•°æ®å¹¶ç»™å‡ºå»ºè®®')">
              <div class="prompt-icon">ğŸ“Š</div>
              <div class="prompt-title">æ•°æ®åˆ†æå¸ˆ</div>
              <div class="prompt-desc">æ•°æ®åˆ†æã€å›¾è¡¨è§£è¯»</div>
            </div>
            
            <div class="prompt-item" onclick="usePrompt('default', 'å¸®æˆ‘è§„åˆ’ä¸‹ä»Šå¤©çš„å·¥ä½œ')">
              <div class="prompt-icon">ğŸ“‹</div>
              <div class="prompt-title">é»˜è®¤åŠ©æ‰‹</div>
              <div class="prompt-desc">æ—¥å¸¸é—®ç­”ã€ä»»åŠ¡è§„åˆ’</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // ä½¿ç”¨æç¤ºè¯
    function usePrompt(role, prompt) {
      document.getElementById('roleSelect').value = role;
      changeRole();
      
      document.getElementById('messageInput').value = prompt;
      autoResizeTextarea();
    }
    
    // æ”¹å˜æ¨¡å‹
    function changeModel() {
      currentModel = document.getElementById('modelSelect').value;
      const modelNames = {
        'claude-sonnet-4-20250514': 'Claude Sonnet 4',
        'claude-haiku-3-20250514': 'Claude Haiku 3',
        'gpt-4o': 'GPT-4o',
        'gpt-4o-mini': 'GPT-4o Mini',
        'deepseek-chat': 'DeepSeek Chat'
      };
      document.getElementById('currentModel').textContent = modelNames[currentModel];
    }
    
    // æ”¹å˜è§’è‰²
    function changeRole() {
      currentRole = document.getElementById('roleSelect').value;
    }
    
    // å¤„ç†é”®ç›˜äº‹ä»¶
    function handleKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }
    
    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    function autoResizeTextarea() {
      const textarea = document.getElementById('messageInput');
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    }
    
    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      
      if (!message || isLoading) return;
      
      // æ¸…ç©ºç©ºçŠ¶æ€
      const emptyState = document.getElementById('emptyState');
      if (emptyState) {
        emptyState.remove();
      }
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage('user', message);
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      input.value = '';
      autoResizeTextarea();
      
      // è®¾ç½®åŠ è½½çŠ¶æ€
      isLoading = true;
      document.getElementById('sendBtn').disabled = true;
      
      // æ·»åŠ åŠ è½½åŠ¨ç”»
      const loadingId = addLoadingMessage();
      
      try {
        const token = localStorage.getItem('aimum_token');
        
        const res = await fetch(`${API_BASE}/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            message,
            conversationId: currentConversationId,
            model: currentModel,
            role: currentRole
          })
        });
        
        const data = await res.json();
        
        // ç§»é™¤åŠ è½½åŠ¨ç”»
        removeMessage(loadingId);
        
        if (data.success) {
          // æ›´æ–°å¯¹è¯ ID
          if (!currentConversationId && data.data.conversationId) {
            currentConversationId = data.data.conversationId;
          }
          
          // æ·»åŠ  AI å›å¤
          addMessage('assistant', data.data.message.content);
        } else {
          addMessage('assistant', `é”™è¯¯: ${data.error}`);
        }
      } catch (error) {
        removeMessage(loadingId);
        addMessage('assistant', `ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•`);
      }
      
      isLoading = false;
      document.getElementById('sendBtn').disabled = false;
    }
    
    // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
    function addMessage(role, content) {
      const messagesEl = document.getElementById('messages');
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;
      messageDiv.innerHTML = `
        <div class="message-avatar">${role === 'user' ? 'ğŸ‘¤' : 'ğŸ¦'}</div>
        <div class="message-content">
          <div class="message-role">${role === 'user' ? 'ä½ ' : 'AI åŠ©æ‰‹'}</div>
          <div class="message-text">${formatMessage(content)}</div>
        </div>
      `;
      
      messagesEl.appendChild(messageDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    
    // æ·»åŠ åŠ è½½åŠ¨ç”»
    function addLoadingMessage() {
      const messagesEl = document.getElementById('messages');
      const loadingId = 'loading_' + Date.now();
      
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message assistant';
      loadingDiv.id = loadingId;
      loadingDiv.innerHTML = `
        <div class="message-avatar">ğŸ¦</div>
        <div class="message-content">
          <div class="message-role">AI åŠ©æ‰‹</div>
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      
      messagesEl.appendChild(loadingDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      
      return loadingId;
    }
    
    // ç§»é™¤æ¶ˆæ¯
    function removeMessage(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }
    
    // æ ¼å¼åŒ–æ¶ˆæ¯
    function formatMessage(text) {
      // è½¬ä¹‰ HTML
      let formatted = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      
      // ä»£ç å—
      formatted = formatted.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
      
      // è¡Œå†…ä»£ç 
      formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
      
      // æ¢è¡Œ
      formatted = formatted.replace(/\n/g, '<br>');
      
      return formatted;
    }
    
    // åŠ è½½å†å²æ¶ˆæ¯
    async function loadHistory(conversationId) {
      const token = localStorage.getItem('aimum_token');
      
      try {
        const res = await fetch(`${API_BASE}/history?conversationId=${conversationId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await res.json();
        
        if (data.success && data.data.history) {
          // æ¸…ç©ºæ¶ˆæ¯åŒº
          document.getElementById('messages').innerHTML = '';
          
          // æ˜¾ç¤ºå†å²æ¶ˆæ¯
          data.data.history.forEach(msg => {
            addMessage(msg.role, msg.content);
          });
        }
      } catch (error) {
        console.error('åŠ è½½å†å²å¤±è´¥:', error);
      }
    }
  </script>
</body>
</html>
