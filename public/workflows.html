<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AImum - å·¥ä½œæµå¼•æ“</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #667eea;
      --bg: #0f0f23;
      --card: #1a1a2e;
      --card-hover: #252542;
      --text: #e2e8f0;
      --text-dim: #a0aec0;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: rgba(255,255,255,0.1);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      padding: 40px 20px;
      margin-bottom: 30px;
    }
    
    h1 {
      font-size: 36px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .subtitle {
      color: var(--text-dim);
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 20px;
    }
    
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab:hover {
      background: var(--card-hover);
    }
    
    .tab.active {
      background: var(--primary);
      color: white;
    }
    
    .toolbar {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a67d8;
    }
    
    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--card-hover);
    }
    
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 12px 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 14px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* å·¥ä½œæµå¡ç‰‡ */
    .workflows-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }
    
    .workflow-card {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .workflow-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
    }
    
    .workflow-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .workflow-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--primary), #764ba2);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
    }
    
    .workflow-info {
      flex: 1;
    }
    
    .workflow-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .workflow-desc {
      font-size: 13px;
      color: var(--text-dim);
      margin-bottom: 12px;
    }
    
    .workflow-meta {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--text-dim);
    }
    
    .workflow-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .workflow-badge.enabled {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }
    
    .workflow-badge.disabled {
      background: rgba(255,255,255,0.1);
      color: var(--text-dim);
    }
    
    .workflow-steps {
      display: flex;
      align-items: center;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .step-preview {
      display: flex;
      align-items: center;
    }
    
    .step-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--card-hover);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-right: 8px;
    }
    
    .step-arrow {
      color: var(--text-dim);
      margin: 0 8px;
    }
    
    /* æ¨¡æ¿åŒºåŸŸ */
    .templates-section {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 30px;
    }
    
    .templates-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
    }
    
    .template-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .template-card:hover {
      border-color: var(--primary);
    }
    
    .template-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .template-name {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .template-desc {
      font-size: 12px;
      color: var(--text-dim);
    }
    
    /* æ‰§è¡Œå†å² */
    .executions-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .execution-item {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .execution-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .execution-icon.running {
      background: rgba(102, 126, 234, 0.2);
    }
    
    .execution-icon.completed {
      background: rgba(16, 185, 129, 0.2);
    }
    
    .execution-icon.failed {
      background: rgba(239, 68, 68, 0.2);
    }
    
    .execution-info {
      flex: 1;
    }
    
    .execution-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .execution-meta {
      font-size: 12px;
      color: var(--text-dim);
    }
    
    .execution-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .execution-status.running {
      background: rgba(102, 126, 234, 0.2);
      color: var(--primary);
    }
    
    .execution-status.completed {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }
    
    .execution-status.failed {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }
    
    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .empty-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 10px;
    }
    
    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
      }
      
      .search-input {
        width: 100%;
      }
      
      .workflows-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ”„ å·¥ä½œæµå¼•æ“</h1>
      <p class="subtitle">è‡ªåŠ¨åŒ–ä»»åŠ¡æµç¨‹ï¼Œæå‡å·¥ä½œæ•ˆç‡</p>
    </header>
    
    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('workflows')">
        ğŸ“‹ æˆ‘çš„å·¥ä½œæµ
      </button>
      <button class="tab" onclick="switchTab('templates')">
        ğŸ“¦ æ¨¡æ¿åº“
      </button>
      <button class="tab" onclick="switchTab('executions')">
        ğŸ“Š æ‰§è¡Œå†å²
      </button>
    </div>
    
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
      <input type="text" class="search-input" placeholder="æœç´¢å·¥ä½œæµ..." onkeyup="searchWorkflows(event)">
      <button class="btn btn-primary" onclick="showCreateModal()">
        â• åˆ›å»ºå·¥ä½œæµ
      </button>
      <button class="btn btn-secondary" onclick="refreshData()">
        ğŸ”„ åˆ·æ–°
      </button>
    </div>
    
    <!-- æ¨¡æ¿åŒºåŸŸ -->
    <div class="templates-section" id="templatesSection">
      <div class="templates-title">
        ğŸš€ å¿«é€Ÿå¼€å§‹ - ä»æ¨¡æ¿åˆ›å»º
      </div>
      <div class="templates-grid" id="templatesGrid">
        <!-- æ¨¡æ¿ä¼šåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
    
    <!-- å·¥ä½œæµåˆ—è¡¨ -->
    <div class="workflows-grid" id="workflowsGrid">
      <!-- å·¥ä½œæµä¼šåŠ¨æ€åŠ è½½ -->
    </div>
    
    <!-- æ‰§è¡Œå†å² -->
    <div class="executions-list" id="executionsList" style="display: none;">
      <!-- æ‰§è¡Œè®°å½•ä¼šåŠ¨æ€åŠ è½½ -->
    </div>
  </div>
  
  <script>
    const API_BASE = '/api/workflow';
    let currentTab = 'workflows';
    let workflows = [];
    let templates = [];
    let executions = [];
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadTemplates();
      loadWorkflows();
      loadExecutions();
    });
    
    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.textContent.toLowerCase().includes(tab));
      });
      
      document.getElementById('templatesSection').style.display = tab === 'templates' ? 'block' : 'none';
      document.getElementById('workflowsGrid').style.display = tab === 'workflows' ? 'grid' : 'none';
      document.getElementById('executionsList').style.display = tab === 'executions' ? 'flex' : 'none';
      
      if (tab === 'executions') {
        loadExecutions();
      }
    }
    
    // åŠ è½½æ¨¡æ¿
    async function loadTemplates() {
      try {
        const res = await fetch(`${API_BASE}/templates`);
        const data = await res.json();
        
        if (data.success) {
          templates = data.data.templates;
          renderTemplates();
        }
      } catch (error) {
        console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
      }
    }
    
    // æ¸²æŸ“æ¨¡æ¿
    function renderTemplates() {
      const grid = document.getElementById('templatesGrid');
      
      grid.innerHTML = templates.map(template => `
        <div class="template-card" onclick="createFromTemplate('${template.id}')">
          <div class="template-icon">${template.icon}</div>
          <div class="template-name">${template.name}</div>
          <div class="template-desc">${template.description}</div>
        </div>
      `).join('');
    }
    
    // ä»æ¨¡æ¿åˆ›å»º
    async function createFromTemplate(templateId) {
      try {
        const res = await fetch(`${API_BASE}/from-template`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ templateId })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('âœ… å·¥ä½œæµåˆ›å»ºæˆåŠŸï¼');
          loadWorkflows();
          switchTab('workflows');
        } else {
          alert('åˆ›å»ºå¤±è´¥: ' + data.error);
        }
      } catch (error) {
        console.error('åˆ›å»ºå¤±è´¥:', error);
        alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
    
    // åŠ è½½å·¥ä½œæµ
    async function loadWorkflows(search = '') {
      try {
        let url = `${API_BASE}/workflows`;
        if (search) {
          url += `?search=${encodeURIComponent(search)}`;
        }
        
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
          workflows = data.data.workflows;
          renderWorkflows();
        }
      } catch (error) {
        console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
      }
    }
    
    // æ¸²æŸ“å·¥ä½œæµ
    function renderWorkflows() {
      const grid = document.getElementById('workflowsGrid');
      
      if (workflows.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="empty-icon">ğŸ“‹</div>
            <div class="empty-title">æš‚æ— å·¥ä½œæµ</div>
            <p>ä»æ¨¡æ¿åº“åˆ›å»ºæˆ–æ‰‹åŠ¨åˆ›å»ºæ–°å·¥ä½œæµ</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = workflows.map(workflow => `
        <div class="workflow-card" onclick="openWorkflow('${workflow.workflowId}')">
          <div class="workflow-header">
            <div class="workflow-icon">${workflow.icon || 'ğŸ“‹'}</div>
            <div class="workflow-info">
              <div class="workflow-name">${workflow.name}</div>
              <div class="workflow-desc">${workflow.description || 'æš‚æ— æè¿°'}</div>
              <span class="workflow-badge ${workflow.enabled ? 'enabled' : 'disabled'}">
                ${workflow.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
              </span>
            </div>
          </div>
          <div class="workflow-meta">
            <span>ğŸ“ ${workflow.steps?.length || 0} ä¸ªæ­¥éª¤</span>
            <span>ğŸ·ï¸ ${workflow.category || 'è‡ªå®šä¹‰'}</span>
          </div>
          <div class="workflow-steps">
            <div class="step-preview">
              ${renderStepPreview(workflow.steps)}
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // æ¸²æŸ“æ­¥éª¤é¢„è§ˆ
    function renderStepPreview(steps) {
      if (!steps || steps.length === 0) return '<span style="color: var(--text-dim)">æ— æ­¥éª¤</span>';
      
      const icons = {
        'ai-chat': 'ğŸ¤–',
        'ai-analysis': 'ğŸ“ˆ',
        'approval': 'âœ…',
        'condition': 'ğŸ”€',
        'notification': 'ğŸ“±',
        'webhook': 'ğŸ”—',
        'data-fetch': 'ğŸ“¥',
        'delay': 'â°'
      };
      
      return steps.slice(0, 3).map((step, i) => `
        <div class="step-dot">${icons[step.type] || 'ğŸ“‹'}</div>
        ${i < Math.min(2, steps.length - 1) ? '<span class="step-arrow">â†’</span>' : ''}
      `).join('') + (steps.length > 3 ? '<span class="step-dot" style="background: var(--card-hover)">+' + (steps.length - 3) + '</span>' : '');
    }
    
    // æœç´¢å·¥ä½œæµ
    function searchWorkflows(event) {
      loadWorkflows(event.target.value);
    }
    
    // æ‰“å¼€å·¥ä½œæµè¯¦æƒ…
    function openWorkflow(workflowId) {
      window.location.href = `/workflow.html?id=${workflowId}`;
    }
    
    // æ˜¾ç¤ºåˆ›å»ºæ¨¡æ€æ¡†
    function showCreateModal() {
      alert('åˆ›å»ºå·¥ä½œæµåŠŸèƒ½å¼€å‘ä¸­...\n\nå¯ä»¥ä½¿ç”¨æ¨¡æ¿å¿«é€Ÿåˆ›å»ºå·¥ä½œæµï¼');
    }
    
    // åŠ è½½æ‰§è¡Œå†å²
    async function loadExecutions() {
      try {
        const res = await fetch(`${API_BASE}/executions`);
        const data = await res.json();
        
        if (data.success) {
          executions = data.data.executions;
          renderExecutions();
        }
      } catch (error) {
        console.error('åŠ è½½æ‰§è¡Œå†å²å¤±è´¥:', error);
      }
    }
    
    // æ¸²æŸ“æ‰§è¡Œå†å²
    function renderExecutions() {
      const list = document.getElementById('executionsList');
      
      if (executions.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <div class="empty-title">æš‚æ— æ‰§è¡Œè®°å½•</div>
            <p>è¿è¡Œå·¥ä½œæµåä¼šæ˜¾ç¤ºæ‰§è¡Œå†å²</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = executions.map(exec => `
        <div class="execution-item">
          <div class="execution-icon ${exec.status}">
            ${exec.status === 'running' ? 'ğŸ”„' : exec.status === 'completed' ? 'âœ…' : 'âŒ'}
          </div>
          <div class="execution-info">
            <div class="execution-name">${exec.workflowName}</div>
            <div class="execution-meta">
              å¼€å§‹æ—¶é—´: ${new Date(exec.createdAt).toLocaleString()}
            </div>
          </div>
          <span class="execution-status ${exec.status}">
            ${exec.status === 'running' ? 'æ‰§è¡Œä¸­' : exec.status === 'completed' ? 'å·²å®Œæˆ' : 'å¤±è´¥'}
          </span>
        </div>
      `).join('');
    }
    
    // åˆ·æ–°æ•°æ®
    function refreshData() {
      loadTemplates();
      loadWorkflows();
      loadExecutions();
      alert('âœ… æ•°æ®å·²åˆ·æ–°ï¼');
    }
  </script>
</body>
</html>
